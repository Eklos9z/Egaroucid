# Egaroucid Book詳説

オセロAI EgaroucidにおけるBook関連機能の使い方(作者の使い方)を解説します。あくまでも作者個人の使い方ですが、Egaroucidはここに書いてある手法でBookを使うことが想定されています。

このページは日本語のみです。

INSERT_TABLE_OF_CONTENTS_HERE

## Bookとは？

Egaroucidにおいて、Bookとは「予め高い精度で計算しておいた評価値集」のことです。

オセロAIは終盤を高速に終局まで読み切ることができますが、序盤、中盤は終局まで読み切ることができません。そういった場合には評価関数を用いて、終局前の局面の状態から終局結果を予測したものを正しいであろう結果として用います。しかし、当然ながら評価関数は完璧なものではありません。2石損くらいの悪手は判定できないこともしばしばあります。そこで、序盤から中盤にかけて、長い時間をかけて様々な局面の評価値を予め計算しておくという手法を取ります。



## 基本知識

ここではEgaroucidのBookに関する基本知識を解説します。EdaxのBookと設計思想は近いので、EdaxのBookについてよくご存知の方は軽く読む程度で結構です。

### Bookの構造

最初から詳しい話になってしまいますが、先に見せると良いと思ったので最初にBookの構造を解説します。

EgaroucidのBookでは、各ボードについて以下の情報が記録されています。

<div class="table_wrapper"><table>
    <tr>
    	<th>名前</th>
       	<th>内容</th>
    </tr>
    <tr>
    	<td>ボード</td>
        <td>手番のプレイヤの石の配置、および相手の石の配置</td>
    </tr>
    <tr>
    	<td>評価値</td>
        <td>手番側の目線での評価値(「この盤面で最善手を打てばX石勝ちになる」という意味)</td>
    </tr>
    <tr>
    	<td>レベル</td>
        <td>評価値計算に使ったAIのレベル(先読み手数などがわかるように記録)</td>
    </tr>
    <tr>
    	<td>ライン数</td>
        <td>この局面から終局まででいくつの局面がBookに登録されているか(Book精度に関係)</td>
    </tr>
    <tr>
    	<td>リーフの評価値</td>
        <td>合法手でBookに登録されていない局面に繋がる手のうちの多分最善手の評価値(Book学習に使用)</td>
    </tr>
    <tr>
    	<td>リーフの手</td>
        <td>合法手でBookに登録されていない局面に繋がる手のうちの多分最善手</td>
    </tr>
    <tr>
    	<td>リーフのレベル</td>
        <td>リーフの評価値と手を計算したAIのレベル</td>
    </tr>
</table></div>
Bookはボード情報に紐付ける形で、評価値などを保存しています。これらの情報の中でユーザが目にする機会が一番多いのが評価値です。これは単純にその局面がどちらにどれだけ有利かを表す値で、一番大事な情報です。この値を正確に効率的に計算(Book学習)するために、他の色々な情報が保存されています。

リーフに関する情報は後述のBook学習で使います。

### Bookを用いたAIの着手

実際にAIがBookを使うときには、各合法手を打ってみてからBookを検索し、登録されている(相手にとっての)評価値とその手をメモしておきます。全ての合法手を展開したら、相手にとっての評価値が一番小さい手(=自分にとっての評価値が一番大きい手)を最善手として使用します。合法手のうち1つでもBookに登録された局面があれば、Bookに登録された局面だけの中から着手を選びます。また、同じ評価値の手が複数ある場合には、最善手の中でランダムに打つ手を選びます。

ちなみに、Edaxではリンクという名前でこれら合法手(のうちBookに登録されている手)を上記のBookの構造に含めています。しかし、リンク情報はBookを何回か検索すればその場で生成できてしまうなど、個人的にはこれは冗長な情報かつBookの構造が煩雑になる気がしたので、Egaroucidでは不採用にしました。

### Bookの精度

Bookに登録されている評価値は、Egaroucidによって予め計算しておいたものです。ですからそれなりに正確であろうと判断できますが、その値が厳密に正しいのかと言われれば、わからないとしか言えません。しかし、評価値がどれくらいしっかり計算されているのかという情報は得ることができます。例えば以下の指標がぱっと思いつくでしょう。

<ul>
    <li>評価値を計算したAIのレベル</li>
    <li>その局面から先の全ての局面のうち、Bookに登録されている局面の数</li>
</ul>

AIのレベルが高ければ、深くまで手を先読みしているので値は信頼できます。また、今の局面から先にたくさんの局面がBookに登録されていれば、その事実もある程度評価値の信頼性に関係します。

これら2つの指標はわかりやすいのですが、Egaroucidは[うえのんEDAX](https://uenon1.com/archives/11111964.html)というソフトの機能に着想を得て、Bookの精度を6段階で表示する仕組みを導入しました。AからFまでの6段階で評価値の精度を評価します。詳細は以下です。

<table>
<tr>
<th>精度</th>
<th>状態</th>
<th>判定基準</th>
</tr>
<tr>
<td>A</td>
<td>値に狂いはほぼない</td>
<td>2石損未満のbook進行の末端が全て完全読み</td>
</tr>
<tr>
<td>B</td>
<td>高信頼</td>
<td>2石損未満のBook進行のうち、1つ以上の末端が完全読みで、その他の末端は終局まで読み切り</td>
</tr>
<tr>
<td>C</td>
<td>正確</td>
<td>2石損未満のBook進行の末端が全て終局まで読み切り</td>
</tr>
<tr>
<td>D</td>
<td>それなりに正確</td>
<td>2石損未満のBook進行の末端の1つ以上が完全読み</td>
</tr>
<tr>
<td>E</td>
<td>まあ正確</td>
<td>2石損未満のBook進行の末端の1つ以上が終局まで読み切り</td>
</tr>
<td>F</td>
<td>値が怪しい</td>
<td>2石損未満のBook進行の末端に終局まで読み切った局面がない</td>
</tr>
</table>

Bookの精度に関する情報は画面に表示することができます。「表示 > 合法手への表示 > Bookライン数」と「表示 > 合法手への表示 > Book精度」をチェックしてみてください。

Book精度の表示は、後述のBook学習にて役に立つと思います。



## 標準付属Bookの仕様

Egaroucidはインストールした時点で作者が作ったBookが付属しています。標準Bookは[Zebra](http://radagast.se/Othello/download.html)のBookをもとに(Zebra作者の許可の上で)値を再計算、追加学習して制作しました。Zebraのbook自体は精度が微妙なところも多いですが、Egaroucidでは再計算と追加学習の結果、とりあえず最善進行についてはかなり正確な値になっていると思います。

標準付属Bookの仕様をざっくりとまとめます。

<table>
<tr>
<th>項目</th>
<th>値</th>
<th>意味</th>
</tr>
<tr>
<td>深さ</td>
<td>32</td>
<td>32手目までの手を登録</td>
</tr>
</table>



## Bookを学習してみる

BookはEgaroucidのソフトを使って自前で学習させることができます。Edaxで言うbook deviateのような機能がEgaroucidには付属しています。

ここでは、作者がEgaroucidのBookを学習させるときにどうやっているのかを解説します。Book学習はいくつか方法が考えられるので、3種類に分けて簡単に解説します。

### 標準Bookを追加学習

まずは標準付属Bookを元に追加で学習をかけるのが楽でおすすめです。



### 1からBookを学習

### EdaxのBookを追加学習



## Bookの体裁を整える

### Book修正

### Book削減



## Bookファイルの構造

Egaroucidのbookは独自フォーマットのバイナリファイル(リトルエンディアン)で保存されています。過去に使っていたフォーマットも含めて構造を説明します。一般ユーザにとって有益な情報とは言えませんが、Egaroucidの改造やBookの操作に役立つかもしれません。

### egbk3フォーマット

拡張子は<code>.egbk3</code>です。

最新のフォーマットです。

<div class="table_wrapper"><table>
    <tr>
    	<th>項目</th>
       	<th>データ量(バイト)</th>
       	<th>内容</th>
    </tr>
    <tr>
    	<td>"EGAROUCID"</td>
        <td>9</td>
        <td>固定の文字列"EGAROUCID"</td>
    </tr>
    <tr>
    	<td>Bookのバージョン</td>
        <td>1</td>
        <td>egbk3フォーマットの場合は3で固定</td>
    </tr>
    <tr>
    	<td>登録局面数</td>
        <td>4</td>
        <td>bookに登録された局面の数</td>
    </tr>
    <tr>
    	<td>局面情報</td>
        <td>25*登録局面数</td>
        <td>登録されている局面のデータ(下記参照)</td>
    </tr>
    </table></div>

登録局面ごとに、以下のデータが保存されています。

<div class="table_wrapper"><table>
    <tr>
    	<th>項目</th>
       	<th>データ量(バイト)</th>
       	<th>内容</th>
    </tr>
    <tr>
    	<td>手番の石の配置</td>
        <td>8</td>
        <td>64bitを使って64マスのそれぞれに手番の石があるかを格納します(MSBがa1)</td>
    </tr>
    <tr>
    	<td>相手の石の配置</td>
        <td>8</td>
        <td>64bitを使って64マスのそれぞれに手番の石があるかを格納します(MSBがa1)</td>
    </tr>
    <tr>
    	<td>評価値</td>
        <td>1</td>
        <td>その局面の評価値</td>
    </tr>
    <tr>
    	<td>レベル</td>
        <td>1</td>
        <td>局面の評価値を計算したAIのレベル</td>
    </tr>
    <tr>
    	<td>ライン数</td>
        <td>4</td>
        <td>その局面の先にいくつの局面がbookに登録されているかを示す値</td>
    </tr>
    <tr>
    	<td>リーフの評価値</td>
        <td>1</td>
        <td>bookに未登録の手のうち、一番良さそうな手の評価値</td>
    </tr>
    <tr>
    	<td>リーフの手</td>
        <td>1</td>
        <td>bookに未登録の手のうち、一番良さそうな手</td>
    </tr>
    <tr>
    	<td>リーフのレベル</td>
        <td>1</td>
        <td>リーフ計算に用いたAIのレベル</td>
    </tr>
    </table></div>

### egbk2フォーマット

拡張子は<code>.egbk2</code>です。Egaroucid 6.5.0まで使われていたものです。

<div class="table_wrapper"><table>
    <tr>
    	<th>項目</th>
       	<th>データ量(バイト)</th>
       	<th>内容</th>
    </tr>
    <tr>
    	<td>"EGAROUCID"</td>
        <td>9</td>
        <td>固定の文字列"EGAROUCID"</td>
    </tr>
    <tr>
    	<td>Bookのバージョン</td>
        <td>1</td>
        <td>egbk2フォーマットの場合は2で固定</td>
    </tr>
    <tr>
    	<td>登録局面数</td>
        <td>4</td>
        <td>bookに登録された局面の数</td>
    </tr>
    <tr>
    	<td>局面情報</td>
        <td>(22+2*リンク数)*登録局面数</td>
        <td>登録されている局面のデータ(下記参照)</td>
    </tr>
</table></div>

登録局面ごとに、以下のデータが保存されています。

<div class="table_wrapper"><table>
    <tr>
    	<th>項目</th>
       	<th>データ量(バイト)</th>
       	<th>内容</th>
    </tr>
    <tr>
    	<td>手番の石の配置</td>
        <td>8</td>
        <td>64bitを使って64マスのそれぞれに手番の石があるかを格納します(MSBがa1)</td>
    </tr>
    <tr>
    	<td>相手の石の配置</td>
        <td>8</td>
        <td>64bitを使って64マスのそれぞれに手番の石があるかを格納します(MSBがa1)</td>
    </tr>
    <tr>
    	<td>評価値</td>
        <td>1</td>
        <td>その局面の評価値</td>
    </tr>
    <tr>
    	<td>レベル</td>
        <td>1</td>
        <td>局面の評価値を計算したAIのレベル</td>
    </tr>
    <tr>
    	<td>リンク数</td>
        <td>4</td>
        <td>その局面の合法手のうちbookに登録されている局面の数</td>
    </tr>
    <tr>
    	<td>リーフ情報</td>
        <td>2*リンク数</td>
        <td>登録されているリンクのデータ</td>
    </tr>
</table></div>

リンクごとに、以下のデータが保存されています。

<div class="table_wrapper"><table>
    <tr>
    	<th>項目</th>
       	<th>データ量(バイト)</th>
       	<th>内容</th>
    </tr>
    <tr>
    	<td>リンクの評価値</td>
        <td>1</td>
        <td>合法手の評価値</td>
    </tr>
    <tr>
    	<td>リンクの手</td>
        <td>1</td>
        <td>登録されている合法手</td>
    </tr>
</table></div>

### egbkフォーマット

拡張子は<code>.egbk</code>です。Egaroucid 6.2.0まで使われていたものです。

<div class="table_wrapper"><table>
    <tr>
    	<th>項目</th>
       	<th>データ量(バイト)</th>
       	<th>内容</th>
    </tr>
    <tr>
    	<td>登録局面数</td>
        <td>4</td>
        <td>bookに登録された局面の数</td>
    </tr>
    <tr>
    	<td>局面情報</td>
        <td>17*登録局面数</td>
        <td>登録されている局面のデータ(下記参照)</td>
    </tr>
</table></div>

登録局面ごとに、以下のデータが保存されています。

<div class="table_wrapper"><table>
    <tr>
    	<th>項目</th>
       	<th>データ量(バイト)</th>
       	<th>内容</th>
    </tr>
    <tr>
    	<td>手番の石の配置</td>
        <td>8</td>
        <td>64bitを使って64マスのそれぞれに手番の石があるかを格納します(MSBがa1)</td>
    </tr>
    <tr>
    	<td>相手の石の配置</td>
        <td>8</td>
        <td>64bitを使って64マスのそれぞれに手番の石があるかを格納します(MSBがa1)</td>
    </tr>
    <tr>
    	<td>評価値</td>
        <td>1</td>
        <td>その局面の評価値に64を足したもの</td>
    </tr>
</table></div>
